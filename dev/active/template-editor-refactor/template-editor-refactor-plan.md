# 문서 생성기(Document Creator) - 템플릿 편집기 리팩토링 계획

> **프로젝트**: Document Creator (Skeleton Analyzer용 문서 생성기)
> **최종 업데이트**: 2026-02-04

---

## 1. 요약

### 1.1 배경
Document Creator는 Skeleton Analyzer에서 생성된 엑셀 데이터를 인체공학적 평가 템플릿(RULA, REBA, OWAS 등)에 매핑하여 문서를 생성하는 PyQt6 기반 데스크톱 애플리케이션입니다.

현재 템플릿 시스템은 개발자가 사전 정의한 템플릿만 사용할 수 있으며, 사용자가 직접 템플릿을 수정하거나 새로 만들기 어렵습니다.

### 1.2 목표
사용자가 직관적으로 템플릿을 생성/수정/관리할 수 있는 위지윅(WYSIWYG) 스타일의 템플릿 편집 시스템 구축

### 1.3 핵심 기능
1. **기본 샘플 템플릿 제공** - OWAS, REBA, RULA 등 기본 템플릿
2. **사용자 커스텀 템플릿** - 기본 템플릿 복사 또는 새로 생성
3. **위지윅 매핑 모드** - 클릭으로 플레이스홀더 지정
4. **템플릿 이름 관리** - 저장/불러오기/삭제/내보내기
5. **전체화면 편집** - 데이터 시트 토글로 편집 영역 최대화
6. **실시간 미리보기** - 편집 중 결과 확인

---

## 2. 현재 상태 분석

### 2.1 현재 아키텍처

```
src/
├── core/
│   ├── template_manager.py    # 템플릿 로드만 담당 (읽기 전용)
│   ├── mapper.py              # 엑셀↔템플릿 필드 매핑
│   └── document_generator.py  # HTML 렌더링
└── ui/
    ├── main_window.py         # 메인 UI
    ├── template_panel.py      # 템플릿 선택 패널
    ├── preview_widget.py      # 미리보기 (QWebEngineView)
    ├── mapping_dialog.py      # 매핑 다이얼로그 (테이블 형식)
    └── excel_viewer.py        # 엑셀 데이터 뷰어
```

### 2.2 현재 한계점

| 영역 | 현재 | 문제점 |
|------|------|--------|
| 템플릿 관리 | 읽기 전용 | 사용자가 새 템플릿 생성/수정 불가 |
| 매핑 UI | 테이블 다이얼로그 | 직관적이지 않음, 위지윅 아님 |
| 화면 구성 | 고정 레이아웃 | 편집 영역 확장 불가 |
| 템플릿 저장 | 매핑만 저장 | 템플릿 자체 저장/관리 없음 |
| 기본 템플릿 | 하드코딩 | 사용자 템플릿과 구분 없음 |

### 2.3 현재 UI 흐름

```
1. 메인 윈도우 (고정)
   ├─ 상단: TemplatePanel들 (수평 스크롤)
   └─ 하단: ExcelViewer (데이터 테이블)

2. 매핑 설정: MappingDialog (모달)
   └─ 테이블 형식으로 필드-컬럼 연결

3. 미리보기: PreviewWidget (패널 내 고정 크기)
```

---

## 3. 제안된 미래 상태

### 3.1 새로운 아키텍처

```
src/
├── core/
│   ├── template_manager.py    # 템플릿 CRUD (읽기/쓰기)
│   ├── template_storage.py    # [신규] 템플릿 저장소 관리
│   ├── mapper.py              # 매핑 (기존 유지)
│   └── document_generator.py  # 렌더링 (기존 유지)
└── ui/
    ├── main_window.py         # [수정] 토글 레이아웃
    ├── template_editor/       # [신규] 템플릿 편집기 모듈
    │   ├── __init__.py
    │   ├── editor_widget.py   # 편집기 메인 위젯
    │   ├── wysiwyg_view.py    # 위지윅 HTML 편집 뷰
    │   ├── mapping_overlay.py # 매핑 오버레이 (클릭→필드)
    │   ├── field_picker.py    # 필드 선택 팝업
    │   └── template_manager_dialog.py  # 템플릿 관리 다이얼로그
    ├── collapsible_panel.py   # [신규] 접기/펼치기 패널
    ├── preview_widget.py      # [수정] 전체화면 지원
    └── excel_viewer.py        # [수정] 접기 기능
```

### 3.2 새로운 UI 구조

#### 3.2.1 메인 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 메뉴바: 파일 | 편집 | 템플릿 | 보기 | 도움말                      [_][□][X] │
├──────────────────────────────────────────────────────────────────────────────┤
│ ┌─ 상단 툴바 ──────────────────────────────────────────────────────────────┐ │
│ │                                                                          │ │
│ │ ── 파일 ──────────  ── 데이터 시트 ────  ── 템플릿 ─────────────────────  │ │
│ │ [📂 열기] [💾 저장] │ [📊 시트 표시/숨김] │ [OWAS ▼] [➕ 새로] [📋 관리]  │ │
│ │                     │ [🔄 새로고침]       │                               │ │
│ │ ── 편집 모드 ─────  │                     │ ── 뷰 ───────────────────────  │ │
│ │ [◉ 편집] [○ 미리]  │                     │ [🔍 100% ▼] [⛶ 전체화면]     │ │
│ │ [○ 매핑]           │                     │                               │ │
│ │                                                                          │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌─ 데이터 시트 (토글) ─────────────────────────────────────────────────────┐ │
│ │ 📂 sample.xlsx                              미리보기 행: [1 ▼] / 156행   │ │
│ │ ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐         │ │
│ │ │ ☑     │ Frame  │ Back   │ Arms   │ Legs   │ Load   │  AC    │ ...     │ │
│ │ ├────────┼────────┼────────┼────────┼────────┼────────┼────────┤         │ │
│ │ │ ☑     │   1    │   2    │   1    │   2    │   1    │   2    │         │ │
│ │ │ ☑     │   2    │   1    │   2    │   1    │   1    │   1    │         │ │
│ │ │ ☐     │   3    │   2    │   1    │   2    │   2    │   3    │         │ │
│ │ └────────┴────────┴────────┴────────┴────────┴────────┴────────┘         │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌─ 템플릿 편집기 ──────────────────────────────────────────────────────────┐ │
│ │ ┌────────────────────────────────────────────────────────────────────┐   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │          (편집 모드 / 미리보기 모드 / 매핑 모드)                   │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ └────────────────────────────────────────────────────────────────────┘   │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌─ 하단 상태바 ────────────────────────────────────────────────────────────┐ │
│ │ ✓ 템플릿: OWAS 기본 | 매핑: 6/6 완료 | 선택: 3행    [📄 문서 생성]      │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 데이터 시트 숨김 상태 (편집 영역 최대화)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 메뉴바: 파일 | 편집 | 템플릿 | 보기 | 도움말                      [_][□][X] │
├──────────────────────────────────────────────────────────────────────────────┤
│ ┌─ 상단 툴바 ──────────────────────────────────────────────────────────────┐ │
│ │ ── 파일 ──────────  ── 데이터 시트 ────  ── 템플릿 ─────────────────────  │ │
│ │ [📂 열기] [💾 저장] │ [📊 시트 표시/숨김] │ [OWAS ▼] [➕ 새로] [📋 관리]  │ │
│ │                     │  ↑ (활성 = 표시됨)  │                               │ │
│ │ ── 편집 모드 ─────  │ [🔄 새로고침]       │ ── 뷰 ───────────────────────  │ │
│ │ [◉ 편집] [○ 미리]  │                     │ [🔍 100% ▼] [⛶ 전체화면]     │ │
│ │ [○ 매핑]           │                     │                               │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌─ 템플릿 편집기 (확장됨) ─────────────────────────────────────────────────┐ │
│ │ ┌────────────────────────────────────────────────────────────────────┐   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │          (편집 영역이 전체 공간 사용)                              │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ │                                                                    │   │ │
│ │ └────────────────────────────────────────────────────────────────────┘   │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌─ 하단 상태바 ────────────────────────────────────────────────────────────┐ │
│ │ ✓ 템플릿: OWAS 기본 | 매핑: 6/6 완료 | 📂 sample.xlsx (156행, 3행 선택) │ │
│ └──────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.3 상단 툴바 상세 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─ 파일 ─────────┐ │ ┌─ 데이터 시트 ──────┐ │ ┌─ 템플릿 ────────────────┐  │
│  │                │ │ │                    │ │ │                        │  │
│  │ [📂] [💾]      │ │ │ [📊] [🔄]          │ │ │ [▼ 선택] [➕] [📋]     │  │
│  │ 열기  저장     │ │ │ 표시  새로         │ │ │          새로  관리    │  │
│  │                │ │ │ 숨김  고침         │ │ │          만들기        │  │
│  └────────────────┘ │ └────────────────────┘ │ └────────────────────────┘  │
│                     │                        │                             │
│  ┌─ 편집 모드 ────┐ │                        │ ┌─ 뷰 ───────────────────┐  │
│  │                │ │                        │ │                        │  │
│  │ [◉] [○] [○]   │ │                        │ │ [🔍 100% ▼] [⛶]       │  │
│  │ 편집 미리 매핑 │ │                        │ │   줌        전체화면   │  │
│  │      보기     │ │                        │ │                        │  │
│  └────────────────┘ │                        │ └────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

분리자: │ (수직선) 또는 QFrame separator 사용
```

#### 3.2.4 툴바 버튼 정의

| 그룹 | 버튼 | 아이콘 | 단축키 | 설명 |
|------|------|--------|--------|------|
| **파일** | 열기 | 📂 | Ctrl+O | 엑셀 파일 열기 |
| | 저장 | 💾 | Ctrl+S | 템플릿 저장 |
| **데이터 시트** | 표시/숨김 | 📊 | Ctrl+D | 데이터 시트 토글 (체크 가능 버튼) |
| | 새로고침 | 🔄 | F5 | 엑셀 데이터 다시 로드 |
| **템플릿** | 선택 | ▼ | - | 템플릿 드롭다운 |
| | 새로 만들기 | ➕ | Ctrl+N | 새 템플릿 생성 |
| | 관리 | 📋 | - | 템플릿 관리 다이얼로그 |
| **편집 모드** | 편집 | - | Ctrl+E | HTML 편집 모드 |
| | 미리보기 | - | Ctrl+P | 미리보기 모드 |
| | 매핑 | - | Ctrl+M | 매핑 모드 |
| **뷰** | 줌 | 🔍 | - | 확대/축소 드롭다운 |
| | 전체화면 | ⛶ | F11 | 전체화면 토글 |

### 3.3 모드별 기능

| 모드 | 기능 |
|------|------|
| **편집 모드** | HTML 소스 직접 편집 (구문 강조) |
| **미리보기 모드** | 렌더링된 결과 확인 (현재 행 데이터 적용) |
| **매핑 모드** | 클릭 위치에 플레이스홀더 삽입, 필드 목록 표시 |

### 3.4 템플릿 저장 구조

```
templates/
├── _builtin/              # [신규] 기본 제공 템플릿 (읽기 전용)
│   ├── owas/
│   │   ├── owas.html
│   │   └── owas.mapping.json
│   ├── reba/
│   └── rula/
├── user/                  # [신규] 사용자 템플릿
│   ├── my-owas-v2/
│   │   ├── template.html
│   │   └── mapping.json
│   └── company-template/
└── sample/                # 샘플 이미지/HTML (유지)
```

---

## 4. 테스트 전략 (TDD)

### 4.1 테스트 계층

```
tests/
├── unit/                  # 단위 테스트
│   ├── test_template_storage.py
│   ├── test_template_manager_v2.py
│   └── test_mapping_overlay.py
├── integration/           # 통합 테스트
│   ├── test_template_crud.py
│   └── test_editor_workflow.py
└── ui/                    # UI 테스트 (pytest-qt)
    ├── test_editor_widget.py
    ├── test_collapsible_panel.py
    └── test_wysiwyg_view.py
```

### 4.2 핵심 테스트 케이스

1. **TemplateStorage**
   - 기본 템플릿 목록 조회
   - 사용자 템플릿 저장/로드/삭제
   - 템플릿 이름 중복 처리
   - 템플릿 복사 (기본→사용자)

2. **MappingOverlay**
   - 클릭 위치에서 플레이스홀더 삽입
   - 기존 플레이스홀더 하이라이트
   - 필드 선택 팝업 표시

3. **CollapsiblePanel**
   - 접기/펼치기 토글
   - 애니메이션 동작
   - 접힌 상태에서 요약 정보 표시

4. **EditorWidget**
   - 모드 전환 (편집↔미리보기↔매핑)
   - 템플릿 변경 시 저장 확인
   - 전체화면 토글

---

## 5. 구현 단계

### Phase 1: 기반 구조 (필수)
- 템플릿 저장소 시스템 구현
- 접기/펼치기 패널 구현
- 메인 윈도우 레이아웃 변경

### Phase 2: 템플릿 편집기 (핵심)
- 편집기 위젯 기본 구조
- 3가지 모드 (편집/미리보기/매핑)
- 템플릿 관리 다이얼로그

### Phase 3: 위지윅 매핑 (핵심)
- 매핑 오버레이 구현
- 필드 선택 팝업
- 플레이스홀더 하이라이트

### Phase 4: 고급 기능 (선택)
- 템플릿 내보내기/가져오기
- 실행 취소/다시 실행
- 키보드 단축키

---

## 6. 리스크 및 완화 전략

| 리스크 | 영향 | 확률 | 완화 전략 |
|--------|------|------|-----------|
| QWebEngineView 편집 제한 | 높음 | 중간 | 별도 HTML 에디터 + 미리보기 분리 |
| 기존 템플릿 호환성 | 중간 | 낮음 | 마이그레이션 스크립트 제공 |
| 복잡한 HTML 구조 처리 | 중간 | 높음 | 플레이스홀더 위치만 관리, HTML 구조 유지 |
| 성능 (대용량 템플릿) | 낮음 | 중간 | 지연 로딩, 캐싱 |

---

## 7. 성공 지표

| 지표 | 목표 |
|------|------|
| 사용자 템플릿 생성 시간 | 기존 대비 80% 단축 |
| 매핑 설정 클릭 수 | 기존 대비 50% 감소 |
| 테스트 커버리지 | 80% 이상 |
| 기존 기능 회귀 | 0건 |

---

## 8. 의존성

### 8.1 기존 의존성 (유지)
- PyQt6 >= 6.6.0
- PyQt6-WebEngine >= 6.6.0
- Jinja2 >= 3.1.0

### 8.2 신규 의존성 (검토 필요)
- QScintilla (선택) - 구문 강조 에디터
- 또는 pygments + QTextEdit 조합

---

## 9. 타임라인 추정

| 단계 | 작업 | 예상 노력 |
|------|------|-----------|
| Phase 1 | 기반 구조 | M (중간) |
| Phase 2 | 템플릿 편집기 | L (대형) |
| Phase 3 | 위지윅 매핑 | L (대형) |
| Phase 4 | 고급 기능 | M (중간) |
| 테스트 | 전체 테스트 | M (중간) |

**총 예상**: XL (대형 프로젝트)
